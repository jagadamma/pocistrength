name: Terraform Plan - ap-south-1

on:
  pull_request:
    branches:
      - dev-test
  workflow_dispatch:

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  terraform_plan:
    name: Terraform Plan - ap-south-1
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: jagadamma/pocistrength/dev/ap-south-1

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ASSUME }}
          aws-region: ap-south-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan -input=false -no-color > plan.txt

      - name: Comment Plan on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: terraform-plan-ap-south-1
          message: |
            âœ… **Terraform Plan â€“ ap-south-1**

            <details>
            <summary>ğŸ“„ Show Plan</summary>

            ```hcl
            $(cat plan.txt)
            ```

            </details>

            ğŸ§‘â€ğŸ’» Triggered by @${{ github.actor }}
